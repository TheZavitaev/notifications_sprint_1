[![wemake-python-styleguide](https://img.shields.io/badge/style-wemake-000000.svg)](https://github.com/wemake-services/wemake-python-styleguide)
[![workflow](https://github.com/medik88/ugc_sprint_2/workflows/ugc_deploy/badge.svg)](https://github.com/TheZavitaev/notifications_sprint_1/actions)
[![Imports: isort](https://img.shields.io/badge/%20imports-isort-%231674b1?style=flat&labelColor=ef8336)](https://pycqa.github.io/isort/)


# Проектная работа 10 спринта
Сервис для отправки уведомлений.

## Система состоит из следующих элементов:

### Ядро системы - это админка.

[Подробнее в README](admin/readme.md)

Контент-менеджер создает шаблон, присваивает ему тип рассылки и способ отправки.
У шаблона есть параметр `code` - вид шаблона. По этому параметру воркер определяет нужно ли для этого шаблона собирать контекст и как это делать. Сейчас есть два вида шаблонов: common и monthly_personal_statistic. Для common контекст не собирается. В сообщение на этапе шаблонизации подставится только first_name и second_name пользователя. Для шаблонов вида monthly_personal_statistic собирается количество просмотренных фильмов за месяц и любимый жанр пользователя.

После этого контент-менеджер создает "задание". 

В задании необходимо указать используемый шаблон, приоритет, контекст, список пользователей, список категорий пользователей и планируемое время отправки.

Шаблоны и задания хранятся в Postgres. Далее с заданиями работает шедулер.

### Scheduler - спусковой крючек для отправки заданий

[Подробнее в README](scheduler/readme.md)

Шедулер поллит БД админки и достает задания которые нужно отправить, превращает категорию пользователей в список пользователей, разбивает задание на чанки с фиксированным количеством пользователей и отправляет дальше.

### API - единая точка входа.

[Подробнее в README](api/readme.md)

Если просто, то АПИшка принимает запросы по сети от внешних сервисов и шедулера, и перекладывает их RabbitMQ.

### Worker - несчастный разгребатель.

[Подробнее в README](worker/readme.md)

Воркер достает новые задания для отправки из RabbitMQ.
Для каждого задания он достает template из базы, для каждого пользователя в задании запрашивает его данные (фамилия, имя, почта), собирает контекст (если это необходимо), шаблонизирует письмо собранным контекстом и отправляет нужным транспортом. Также воркер проверяет хочет ли пользователть получать рекламные сообщения.

### User service

[Подробнее в README](user_service/readme.md)

Это тестовый сервис для выдачи пользовательских данных. Он возвращает ФИО пользователя, его адрес, настройки уведомлений, категории, статистика просмотра.


## Схема

![schema_api](doc/schema_api.png)

# Как запустить локально

```shell
docker_compose up --build
```
